# config.yaml - 해외주식 자동매도 시스템 설정
# 기획서 v1.1 기준 (2025-10-24 업데이트)
# 모든 시간은 미국 동부시간(ET) 기준

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 1. API 설정
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
api:
  base_url: "https://openapi.koreainvestment.com:9443"
  websocket_url: "ws://ops.koreainvestment.com:21000"
  request_timeout: 15

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 2. 시스템 설정 (기획서 2장, 9장)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
system:
  # 기획서 2.2: 운영 시간 (ET 04:00-12:00 = 8시간)
  operating_hours:
    start: "04:00"  # 한국시간 17:00 (서머타임)
    end: "12:00"    # 한국시간 01:00 (서머타임)
  
  # 기획서 2.3: 12:00에 자동 종료
  auto_shutdown: true
  graceful_shutdown_timeout: 30
  
  # 상태 파일 (기획서 7.1)
  state_file: "/tmp/auto-sell-order-state.json"
  
  # 토큰 관리
  token_refresh_margin_minutes: 5
  approval_margin_seconds: 1800
  
  # WebSocket 재연결 (기획서 5.2: 3회 재시도)
  max_reconnect_attempts: 3
  base_reconnect_delay: 10

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 3. 자동 매도 전략 (기획서 4장)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
order_settings:
  # 기획서 4.1: 수익률 3% 고정
  # ⭐ 수정하려면 여기만 변경하고 시스템 재시작
  target_profit_rate: 3.0  # 단위: %
  
  # 기본 설정
  exchange_code: "NASD"
  order_type: "00"
  timezone: "US/Eastern"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 4. 스마트 폴링 전략 (기획서 3장)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
polling:
  # 기획서 3.1: 프리마켓 모드 (ET 04:00-09:30)
  premarket:
    time_ranges:
      - {start: "04:00", end: "05:00"}   # 고활성: 3초 폴링
      - {start: "05:00", end: "08:00"}   # 저활성: 10초 폴링
      - {start: "08:00", end: "09:30"}   # 고활성: 3초 폴링
    
    interval_seconds:
      high_activity: 3   # 기획서 3.2: 장 시작/종료 1시간
      low_activity: 10   # 기획서 3.2: 중간 시간대
  
  # 기획서 3.1: 정규장 모드 (ET 09:30-12:00)
  regular:
    time_ranges:
      - {start: "09:30", end: "12:00"}
    
    mode: "websocket"  # WebSocket 우선
    fallback: "stop"   # 기획서 2.3: 실패 시 시스템 중지
    
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # 🔴 [v1.1 신규] WebSocket 구독 제한 (기획서 5.1)
    # 2025년 11월 1일부터 적용
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    websocket:
      max_subscriptions: 20 # 기존 41건 → 20건 (약 51% 감소)
  
      # 보유 종목이 20개를 초과할 경우 처리 방식
      subscription_strategy: "priority"
      # ✅ 옵션 설명:
      # - priority: 우선순위(수익률 높은 순) 기반 20개만 선택
      #   → 나머지는 pending으로 분류
      #   → 안전하고 예측 가능한 동작
      # - all: 모든 종목 구독 시도
      #   → 20개 초과 시 오류 발생 → 시스템 종지 위험
      #   → 사용 권장하지 않음
  
      fallback_to_rest_polling: false
      # ✅ 옵션 설명:
      # - false (권장): 우선순위 20개만 실시간 모니터링
      #   → API 호출 최소화
      # - true: 20개 초과 종목은 REST 폴링 병행
      #   → API 호출 증가 (프리마켓 폴링 추가)
      #   → 기획서 3.3: 일일 약 2,000-3,000회 추가 호출

    realtime_quote:
      type: "free"  # 무료 시세만 제공 (약 1초 지연)
      websocket_prefix: "D"  # D=Delayed(무료), R=Real(유료, 중단)
      # 예시: DNASTSLA (무료), RNASTSLA (유료, 더 이상 지원 안 됨)
      # 주의: 약 1초 지연은 정상이며, 3% 목표 수익률 달성에 큰 영향 없음
    
    # WebSocket 실패 시 재시도 (기획서 5.2)
    retry_attempts: 3
    retry_delay: 10

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 5. Rate Limit (기획서 5장)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rate_limit:
  # 🔴 [v1.1 수정] REST API 제한 증가 (기획서 5.1)
  # 기존: 20회/초 → 신규: 50회/초 (150% 증가)
  # 안전 마진 75% 적용: 50 × 0.75 = 37.5 ≈ 37회
  requests_per_second: 37 # 안전 마진: 75% 활용
  min_request_interval: 0.028 # 1초 / 37회 ≈ 0.027초 (반올림 0.028)
  
  # 기획서 5.1: 일일/시간 제한 (변경 없음)
  daily_limit: 5000
  hourly_limit: 500
  
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 🔴 [v1.1 추가] 비상 중지 조건 (기획서 5.2)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  emergency_stop:
    daily_usage_threshold: 0.9  # 90% 도달 시 (4,500회)
    consecutive_errors: 10       # 연속 10회 오류
    no_response_timeout: 300     # 5분간 응답 없음
    websocket_subscription_insufficient: true  # [신규] WebSocket 구독 부족 시 경고
    # 보유 종목 > 20개 && subscription_strategy="all" 시 경고 알림
  
  # Rate Limit 초과 시 대기
  cooldown_seconds: 60

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 6. 텔레그램 알림 (기획서 6.1)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
telegram:
  # 알림 설정
  notifications:
    system_start_stop: true       # 시스템 시작/종료
    mode_change: true             # 프리마켓 ↔ 정규장
    buy_detected: true            # 매수 감지
    sell_success: true            # 매도 성공
    sell_failed: true             # 매도 실패
    errors: true                  # 오류 발생
    rate_limit_warning: true      # Rate Limit 90%
    daily_summary: true           # 일일 통계 (01:00 한국시간)
    websocket_subscription_warning: true  # [v1.1 신규] WebSocket 구독 부족 경고
  
  # 연결 설정
  polling_interval: 10
  error_polling_interval: 30
  timeout: 10

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 7. 로깅 설정 (기획서 6.2)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  
  file:
    path: "logs/app.log"
    max_size_mb: 10
    backup_count: 5
    retention_days: 30
  
  # 콘솔 출력 설정
  console:
    enabled: true
    level: "INFO"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 8. 백업 설정 (기획서 7장)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
backup:
  # 기획서 7.1: 상태 파일 백업
  state_files:
    enabled: true
    path: "/home/ec2-user/backups/states/"
    retention_days: 7
    auto_backup_on_sell: true
    daily_backup_time: "01:00"  # 한국시간 (시스템 종료 시)
  
  # 기획서 7.2: 로그 파일 백업
  log_files:
    enabled: true
    path: "/home/ec2-user/backups/logs/"
    retention_days: 30
    compress: true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 9. 오류 처리 (기획서 8장)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
error_handling:
  # 기획서 8.1: 오류 유형별 재시도
  network_error:
    max_retries: 3
    retry_delay: 10
  
  rate_limit_error:
    max_retries: 1
    retry_delay: 60
  
  auth_error:
    max_retries: 2
    retry_delay: 5
  
  # 기획서 4.4: 매도 실패 처리
  sell_failed:
    retry: false  # 즉시 포기
    log_only: true
    notify_telegram: true
  
  # 기획서 5.2: WebSocket 실패
  websocket_failed:
    action: "stop_system"  # 시스템 중지
    notify_telegram: true

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 📝 변경 이력
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# v1.1 (2025-10-24)
# - WebSocket 구독 20건 제한 반영
# - REST API 50건/초로 증가 (requests_per_second: 15 → 37)
# - 무료 실시간 시세 정책 반영
# - 비상 종지 조건 추가 (websocket_subscription_insufficient)
# - 텔레그램 알림 추가 (websocket_subscription_warning)